/*****************************系统各模块说明**********************************/
一、系统初始化
1、材质台就位
2、相机、光源、材质台控制测试

二、预处理
1、工业相机标定及校正预处理	
	1）辐射度标定（白平衡校正、均匀度校正、颜色校正）
	2）几何标定（棋盘格）
	3）线性度标定（最大曝光时间、自动曝光时间）
	4）坏点标记及暗电平处理
2、单反相机参数设置

三、材质采集
1、BRDF采集
	1）一般采集（各项同性/各向异性）
	光源依次点亮，相机同步采集一帧/多帧，（材质台旋转）
	2）HDR采集（针对低动态范围）
	光源依次点亮，相机同步采集多帧，（材质台旋转）
	3）EOS采集（超分辨率）
	若干指定方向光源，固定方向单反采集多张，（材质台旋转）
2、svBRDF采集
3、BTF采集（待定）

四、图像处理（在上一步图像保存前/下一步拟合前进行）
	1）多帧图像平均去噪
	2）坏点校正和暗点平处理
	3）角度校正、方向对齐、裁剪、极限角度剔除
	4）白平衡处理、均匀度校正、颜色校正
	5）几何校正(Zhang)
	6）HDR、超分辨率
	7）保存处理后图像(/.btf/...)
	8）逐角度计算图像平均亮度/逐像素亮度，保存BRDF材质数据（.xml/.binary/...）

五、BRDF建模、参数拟合（有余力再实现拟合过程可视化）
1、BRDF模型
	1）读取本地材质库
	2）选取模型/模型组
	3）选择拟合方法（待定）
2、svBRDF模型（逐点BRDF、聚类；考虑法向量）
3、BTF模型（建模方法待研究）

五（附）、BRDF模型详细说明（model文件夹暂未添加）
1、文件夹C++程序中是用WardDuer模型拟合BRDF模型参数的C++工程，使用了LM算法库levmar-2.6和opencv 2.4.13，其中附上了opencv库和LM算法库（编译过）。
    工程中需要用到compiler.h、levmar.h、lm.h、misc.h和Axb.c、lm.c、misc.c。
    其中BRDFfitting.cpp是BRDF参数拟合类的具体函数定义，BRDFfitting.h是对该类的声明。
    该类的公有成员函数StartFitting(int BRDFSerialNumber)和BRDFSample(int BRDFSerialNumber)传入参数为需要拟合的原始数据的文件的序号（序号为1-100之间）。
    该类的私有函数ComputeSamplingAngle()目前是对thetaOut和thetaIn以10:5:80、phiIn以5:5:175采样的，剔除了仰角低于10度和高于80度的数据，因为这些数据误差较大，而且采用每隔5度均匀采样以提高可靠性。
    后续可根据采样的需求更改优化。

    如何使用该工程：调用该类的开始拟合函数StartFitting(int BRDFSerialNumber)，传入文件名称序号即可，默认将该原始文件放到文件夹Param中，所有相关的文件都按照序号存放在这里，如采样后的文件以“brdf_simple.binary”形式存储，拟合结果以“WdDu_parameter.txt”存储。

    之所以使用WardDuer模型是由于经过我们的测试以及视觉分析对比，认为CookTorrance和WardDuer模型表现总体最好，而CookTorrance模型不适用于后面要对接的svBRDF。

2、文件夹Matlab程序中包含Fitting拟合代码和遗传算法使用的原始数据Param10_175和MERL文章给出的结果MERL_Param。
    Fitting拟合代码中是6个模型拟合代码如：Objfun_WardDuer.m等等，6个模型拟合误差函数如：fun_WardDuer.m等等，6个遗传算法计算部分参数初值的函数如：Genetic_algorithm_WardDuer.m等等。
    另外还有一个BRDF材质读取函数：BRDFRead.m以及一个采样角度计算函数：ComputeSamplingAngle.m。       
    Fitting拟合程序文件夹中有个Sheffield文件夹，这是谢菲尔德遗传工具箱，遗传算法计算初值时需要用到其中的函数，因此使用拟合程序时需要把这个文件夹添加到路径当中。
    

3、文件夹Param中存放的是使用的BRDF原始数据、采样后的数据和最终的拟合结果。


4、name.txt是Param中100种序号命名的BRDF文件对应的材质名称。


5、Fitting拟合程序中设置了两种初值计算的方法，一种是根据遗传算法得到一个比较可靠的初值，缺点是计算比较耗时；另一种方法是使用经验推荐的初值，这种方法能比较大地提高拟合效率，但是并不是所有材质所有模型都能很可靠，后面可能还会遇到一些比较复杂的材质等情况，需要根据情况考虑使用。
    经过测试，对于MERL数据库，这6个模型除了Lafortune模型难以用一个根据经验推荐的初值得到稳定的结果外，其他5个模型都能根据Fitting拟合程序中推荐的经验初值得到和遗传算法计算初值一致的拟合结果，这相对于使用遗传算法计算初值能节省很多时间。
    针对这一特点，我们Lafortune模型最好使用遗传算法计算初值，其他5种模型推荐使用经验推荐的初值，如果认为个别材质的结果不理想，再针对个别材质使用遗传算法重新拟合进行结果的比较。
    C++程序中WardDuer模型使用的是经验推荐的初值，经过测试对于MERL数据库的材质，该模型使用遗传算法得到的结果与使用经验初值得到的结果一样。该方法能提高拟合效率同时减少程序的繁杂。

